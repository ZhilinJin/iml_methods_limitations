<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Chapter 3 Accumulated Local Effects (ALE) | Limitations of Interpretable Machine Learning Methods</title>
  <meta name="description" content="Situations in which PDP, ALE, LIME, LOCO and feature importance fail.">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="Chapter 3 Accumulated Local Effects (ALE) | Limitations of Interpretable Machine Learning Methods" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Situations in which PDP, ALE, LIME, LOCO and feature importance fail." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Accumulated Local Effects (ALE) | Limitations of Interpretable Machine Learning Methods" />
  
  <meta name="twitter:description" content="Situations in which PDP, ALE, LIME, LOCO and feature importance fail." />
  

<meta name="author" content="">


<meta name="date" content="2019-07-31">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="partial-dependence-plots-pdp-and-individual-conditional-expectation-ice-curves.html">
<link rel="next" href="feature-importance.html">
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />










<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Limitations of ML Interpretability</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#structure-of-the-book"><i class="fa fa-check"></i>Structure of the book</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="partial-dependence-plots-pdp-and-individual-conditional-expectation-ice-curves.html"><a href="partial-dependence-plots-pdp-and-individual-conditional-expectation-ice-curves.html"><i class="fa fa-check"></i><b>2</b> Partial Dependence Plots (PDP) and Individual Conditional Expectation (ICE) Curves</a><ul>
<li class="chapter" data-level="2.1" data-path="partial-dependence-plots-pdp-and-individual-conditional-expectation-ice-curves.html"><a href="partial-dependence-plots-pdp-and-individual-conditional-expectation-ice-curves.html#partial-dependence-plots-pdp"><i class="fa fa-check"></i><b>2.1</b> Partial Dependence Plots (PDP)</a></li>
<li class="chapter" data-level="2.2" data-path="partial-dependence-plots-pdp-and-individual-conditional-expectation-ice-curves.html"><a href="partial-dependence-plots-pdp-and-individual-conditional-expectation-ice-curves.html#individual-conditional-expectation-curves"><i class="fa fa-check"></i><b>2.2</b> Individual Conditional Expectation Curves</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="accumulated-local-effects-ale.html"><a href="accumulated-local-effects-ale.html"><i class="fa fa-check"></i><b>3</b> Accumulated Local Effects (ALE)</a><ul>
<li class="chapter" data-level="3.1" data-path="accumulated-local-effects-ale.html"><a href="accumulated-local-effects-ale.html#motivation"><i class="fa fa-check"></i><b>3.1</b> Motivation</a></li>
<li class="chapter" data-level="3.2" data-path="accumulated-local-effects-ale.html"><a href="accumulated-local-effects-ale.html#the-theoretical-formula"><i class="fa fa-check"></i><b>3.2</b> The Theoretical Formula</a><ul>
<li class="chapter" data-level="3.2.1" data-path="accumulated-local-effects-ale.html"><a href="accumulated-local-effects-ale.html#centering"><i class="fa fa-check"></i><b>3.2.1</b> Centering</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="accumulated-local-effects-ale.html"><a href="accumulated-local-effects-ale.html#estimation-formula"><i class="fa fa-check"></i><b>3.3</b> Estimation Formula</a><ul>
<li class="chapter" data-level="3.3.1" data-path="accumulated-local-effects-ale.html"><a href="accumulated-local-effects-ale.html#implementation-formula"><i class="fa fa-check"></i><b>3.3.1</b> Implementation Formula</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="accumulated-local-effects-ale.html"><a href="accumulated-local-effects-ale.html#intuition-and-interpretation"><i class="fa fa-check"></i><b>3.4</b> Intuition and Interpretation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="feature-importance.html"><a href="feature-importance.html"><i class="fa fa-check"></i><b>4</b> Feature Importance</a><ul>
<li class="chapter" data-level="4.1" data-path="feature-importance.html"><a href="feature-importance.html#permutation-feature-importance-pfi"><i class="fa fa-check"></i><b>4.1</b> Permutation Feature Importance (PFI)</a></li>
<li class="chapter" data-level="4.2" data-path="feature-importance.html"><a href="feature-importance.html#leave-one-covariate-out-loco"><i class="fa fa-check"></i><b>4.2</b> Leave-One-Covariate-Out (LOCO)</a></li>
<li class="chapter" data-level="4.3" data-path="feature-importance.html"><a href="feature-importance.html#interpretability-of-feature-importance-and-its-limitations"><i class="fa fa-check"></i><b>4.3</b> Interpretability of Feature Importance and its Limitations</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="local-interpretable-model-agnostic-explanations.html"><a href="local-interpretable-model-agnostic-explanations.html"><i class="fa fa-check"></i><b>5</b> Local Interpretable Model-Agnostic Explanations</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="_blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Limitations of Interpretable Machine Learning Methods</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="accumulated-local-effects-ale" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> Accumulated Local Effects (ALE)</h1>
<div id="motivation" class="section level2">
<h2><span class="header-section-number">3.1</span> Motivation</h2>
<p>As seen in section 2 PDPs don’t work well as soon as two or more features are correlated. This gives rise to the definition of ALEs. Although their definition makes sense for high dimensional feature spaces including categorical features, within this section we only treat a space with two continous features.</p>
</div>
<div id="the-theoretical-formula" class="section level2">
<h2><span class="header-section-number">3.2</span> The Theoretical Formula</h2>
<p>The uncentered ALE with respect to a starting point <span class="math inline">\(z_{0, j}\)</span> is defined by <span class="citation">(Apley <a href="#ref-Apley2016" role="doc-biblioref">2016</a>)</span> as
<span class="math display">\[  \widetilde{ALE}_{\hat{f},~j}(x) = \hat{f}_{x_j,ALE}(x) = \int_{z_{0,~j}}^{x} E_{X_c \mid X_j} [\hat{f}^j(X_j,~X_c)\mid X_j = z_j]~dz_j,\]</span>
where <span class="math inline">\(\hat{f}\)</span> is an arbitrary prediction function on the featurespace <span class="math inline">\(X = (X_j,X_c)\)</span> (with feature of interest <span class="math inline">\(X_j\)</span> and other features <span class="math inline">\(X_c\)</span>) as well as its j-th partial derivative <span class="math inline">\(\hat{f}^j(*,*)\)</span>.</p>
<div id="centering" class="section level3">
<h3><span class="header-section-number">3.2.1</span> Centering</h3>
<p>The ALE (centered ALE) is defined as</p>
<p><span class="math display">\[  ALE_{\hat{f},~j}(x) = \widetilde{ALE}_{\hat{f},~j}(x) - E_{X_j}[\widetilde{ALE}_{\hat{f},~j}(X_j)]\]</span></p>
<p>The centering makes sense as it helps interpreting the ALE in a reasonable way. This will be explained in section 3.4..</p>
</div>
</div>
<div id="estimation-formula" class="section level2">
<h2><span class="header-section-number">3.3</span> Estimation Formula</h2>
<p>Since this theoretical formula is of no use for a blackbox model with unknown or even non existing gradients, an approximative approach will be used.
The uncentered ALE can be approximated by the formula</p>
<p><span class="math display">\[ \widehat{\widetilde{ALE}}_{\hat{f},~j}(x) = \int_{z_{0,~j}}^{x} \sum_{k=1}^{K}   1_{]z_{k-1,~j},~z_{k,~j}]}(x_j)~ \frac{1}{n_j(k)}\sum_{i:x_j^{(i)}\in N_j(k)} \frac{[\hat{f}(z_{k,~j}, x_{\setminus j}^{(i)})-\hat{f}(z_{k-1,~j}, x_{\setminus j}^{(i)})]}{z_{k,~j}-z_{k-1,~j}}~dx_j~.  \]</span></p>
<p>In a first step the relevant dimension of the feature space is divided into K intervals beginning with the starting point <span class="math inline">\(z_{0, j}\)</span>. As it is not clear how to exactly divide the feature space, section 3.x deals with that question. The upper boundary of the k-th interval is denoted by <span class="math inline">\(z_{k, ~j}\)</span> as well as the lower boundary by <span class="math inline">\(z_{k-1, ~j}\)</span>. <span class="math inline">\(N_j(k)\)</span> denotes the k-th interval, i.e. <span class="math inline">\(]z_{k-1,~j}, z_{k,~j}]\)</span> and <span class="math inline">\(n_j(k)\)</span> the total number of observations having the j-value within this interval. <span class="math inline">\(x_j^{(i)}\)</span> is the j-value of the i-th observation and correspondingly <span class="math inline">\(x_{\setminus j}^{(i)}\)</span> the values of the other features. The term on the right approximates the expected partial derivative within each interval.
Therefore each instance within an interval is shifted to the upper and lower limit of the interval and the total difference of the prediction is calculated. Devided by the length of the interval this is a reasonable approximation for the “local” effect on the prediction, if the feature of interest changes (cet. par.).
By averaging these approximations over all observations within the k-th interval, we recieve a rough estimator for the term <span class="math inline">\(E_{X_c \mid X_j} [\hat{f}^j(X_j,~X_c)\mid X_j \in N_j(k)]\)</span>, which we take as constant effect for the k-th interval.
By integrating over this step function, which represents the locally estimated derivatives, the (local) changes are accumulated. Thats why the name Accumulated Local Effects is quite reasonable.
The approximative formula for the centered ALE follows directly as
<span class="math display">\[   \widehat{ALE}_{\hat{f},~j}(x) = \widehat{\widetilde{ALE}}_{\hat{f},~j}(x) - \frac{1}{n} \sum_{i=1}^{n} \widehat{\widetilde{ALE}}_{\hat{f},~j}(x_j^{(i)})~. 
 \]</span></p>
<div id="implementation-formula" class="section level3">
<h3><span class="header-section-number">3.3.1</span> Implementation Formula</h3>
<p>As both the centered and the uncentered ALE estimations are piecewise linear functions (integration over a step function), one can first calculate the ALE at the interval boundaries and interpolate in a second step. Therefore the folowing formula proposed by <span class="citation">(Apley <a href="#ref-Apley2016" role="doc-biblioref">2016</a>, 11)</span> , with slightly changed notation will be useful. The definitions of its components are as above. Additionally <span class="math inline">\(k_j(x)\)</span> is defined as the number of the interval that contains <span class="math inline">\(x\)</span>, i.e. <span class="math inline">\(x \in ~]z_{k_j(x)-1,~j},~z_{k_j(x),~j}]\)</span>.</p>
<p><span class="math display">\[  \widehat{\widetilde{ALE}}_{steps,~\hat{f},~j}(x) =  \sum_{k=1}^{k_j(x)}   \frac{1}{n_j(k)}\sum_{i:~x_j^{(i)}\in N_j(k)} [\hat{f}(z_{k,~j}, x_{\setminus j}^{(i)})-\hat{f}(z_{k-1,~j},~x_{\setminus j}^{(i)})].  \]</span>
This formula returns a step function. The values in each interval are the accumulated values of the averaged total differences in each interval. To transfer this formula into the correct estimator of the uncentered ALE one has to linearely interpolate the points <span class="math inline">\((z_{k-1,~j},~\widehat{\widetilde{ALE}}_{steps,~\hat{f},~j}(z_{k-1,~j}))\)</span> with <span class="math inline">\(( z_{k,~j},\widehat{\widetilde{ALE}}_{steps,~ \hat{f},~j}(z_{k,~j}))\)</span> for <span class="math inline">\(k \in \{1, ..., K \}\)</span> and <span class="math inline">\(\widehat{\widetilde{ALE}}_{steps, \hat{f},j}(z_{0,~j}) = 0\)</span>.</p>
<p>Since in this formula there is no integral, it is easier to implement.</p>
</div>
</div>
<div id="intuition-and-interpretation" class="section level2">
<h2><span class="header-section-number">3.4</span> Intuition and Interpretation</h2>
<p>As the former sections introduced the theoretical basics for the ALE, this section shall provide an intuition as well for the calculation method as for the interpretation. As described above, the local behaviour of the model with respect to the variable of interest is estimated by moving the existing data points to the boundaries of their interval and evaluating the total difference of the prediction for the “new” data points. Figure <a href="accumulated-local-effects-ale.html#fig:dataALE">3.1</a> first offered by <span class="citation">(Molnar <a href="#ref-molnar2019" role="doc-biblioref">2019</a>)</span> gives a good intuition for this procedure.</p>
<div class="figure"><span id="fig:dataALE"></span>
<img src="images/ale_estimation_intuition.PNG" alt="The data points within the 4-th interval are shifted to the interval boundaries \(z_{3,~1}\) and \(z_{4,~1}\)." width="495" />
<p class="caption">
FIGURE 3.1: The data points within the 4-th interval are shifted to the interval boundaries <span class="math inline">\(z_{3,~1}\)</span> and <span class="math inline">\(z_{4,~1}\)</span>.
</p>
</div>

<p>First one splits the total range of the variable of interest (in this case <span class="math inline">\(x_1\)</span>) to intervals of suitable size.<br />
For each interval the contained data points are moved to the interval boundaries. One gets twice as much “simulated” new data points as originally contained in each interval. The prediction function is now evaluated at this simulated points and the total difference of the prediction (for the given interval) is estimated as the mean change. Divided by the length of the interval one gets an estimation for the partial derivative within this interval. Theoretically one recieves the uncentered ALE by integration over this step function. Technically in a first step the total change per interval is accumulated. In a second step linear interpolation at the interval boundaries simulates a constant change within each interval. Both variants lead to the same result.</p>
<p>As the evaluation is ideally done on relatively small intervals, on the one hand the local behaviour of the model is estimated. On the other hand the covariance structure of the features is taken into account, as only “realistic” data points are simulated. This is in accordance with sampling from the conditional distribution.</p>
<p>In a last step the uncentered ALE is centered, i.e. shifted by a constant such that the expectation of the centered ALE is zero.</p>
<p>Figure <a href="accumulated-local-effects-ale.html#fig:aleEx">3.2</a> shows an example ALE which could match the data situtaion of Figure <a href="accumulated-local-effects-ale.html#fig:dataALE">3.1</a> :</p>
<div class="figure"><span id="fig:aleEx"></span>
<img src="images/ale_example.png" alt="ALE on basis of 5 intervals" width="495" />
<p class="caption">
FIGURE 3.2: ALE on basis of 5 intervals
</p>
</div>

<p>To understand the interpretation of the ALE it can be usefull to first have a look on the intuition behind the uncentered ALE.
If the value of the uncentered ALE at <span class="math inline">\(x_1 = 2\)</span> equals <span class="math inline">\(1\)</span>, this means that if one samples a data point from the joint distribution of both features but only knows that <span class="math inline">\(x_1 = 2\)</span>, one would expect the prediction to be 1 higher than the average prediction for realistic data points at <span class="math inline">\(x_1 = z_{0,1}\)</span> (i.e. data points sampled from the conditional distribution at <span class="math inline">\(x_1 = z_{0,1}\)</span>). This expectation strongly depends on the reference point <span class="math inline">\(z_{0,1}\)</span>, which per definition is smaller than the smallest <span class="math inline">\(x_1\)</span>-value of the data.
By substracting the expectation of the uncentered ALE - which is the mean difference of the prediction of a data point from the joint distibution to the prediction of a realistic data point(i.e. from the conditional distribution) at <span class="math inline">\(x_1 = z_{0,1}\)</span> - the interpretation becomes a lot easier. If the value of the (centered) ALE at <span class="math inline">\(x_1 = 2\)</span> equals for example <span class="math inline">\(2\)</span>, this means that, if one samples a data point from the joint distribution of both features and <span class="math inline">\(x_1\)</span> equals 2, one would expect the prediction to be 2 higher than the average prediction for an average data point of the joint distribution.</p>
<p>So far only the case of 2-dimensional feature spaces with one feature of interest was taken into account. In the following chapters methods and interpretation for ALE with two numeric features (second order effects) or one categorical feature will be in the focus. Furthermore we will have a look on the size of the intervals the data is evaluated on, which can be crucial for the expressiveness of the ALE.</p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-Apley2016">
<p>Apley, Daniel W. 2016. <em>Visualizing the Effects of Predictor Variables in Black Box Supervised Learning Models</em>. <a href="https://arxiv.org/ftp/arxiv/papers/1612/1612.08468.pdf">https://arxiv.org/ftp/arxiv/papers/1612/1612.08468.pdf</a>.</p>
</div>
<div id="ref-molnar2019">
<p>Molnar, Christoph. 2019. <em>Interpretable Machine Learning: A Guide for Making Black Box Models Explainable</em>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="partial-dependence-plots-pdp-and-individual-conditional-expectation-ice-curves.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="feature-importance.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/compstat-lmu/iml_methods_limitations/edit/master/02-ale.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": ["book.pdf", "book.epub", "book.mobi"],
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
