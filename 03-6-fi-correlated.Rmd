# PFI, LOCO and Correlated Features

The method of Feature Importance is a powerful tool to gain insights of black box models assuming that the features of the given dataset are uncorrelated with each other. However, this assumption can be most of the time neglected in reality. As mentioned in chapter 1 some model agnostic tools like the interpretability of PDPs suffer from correlated features. As well as for PDPs the interpretability of Feature Importance can depend on the correlations between the input variables. If all features of  a data set are independent and not correlated, you can can calculate the the feature importance of every feature and there is no problem in the interpretability due to correlation effects. Whereas if there are some correlated feature in the data which is highly possible in reality, then the results of the feature importance do not reflect the individually feature importance. This can lead to misleading ranking of the features and thus to wrong interpretations about the relevance of a feature in a model. 

There are two main problems when you are confronted with correlated features. The following two examples illustrate these issues. The first one and most crucial one is the problem of misleading ranking of correlated features. By adding a correlated feature to the data set it can lead to a decrease in Feature Importance of the feature with which it is correlated. Imagine you want to predict the risk of a heart attack by looking at the weight of a person had yesterday and other uncorrelated features. For instances, you choose a random forest model and calculate the corresponding PFI. It is well know that overweight can be a deciding influence factor for heart attacks and your model as well indicating that weight is the most important feature. What happens if you now also add the weight of the person of today which is highly correlated to the weight of a person yesterday. A big advantage of a random forest model is the application and predictive accuracy of high dimensional data sets. Even in the case of correlated features or interaction effects. So adding a new component should be no problem. However, there can be some effects on the Feature Importance that can make an interpretation more difficult. Since, now the importance kind of splits between both features. During the training of the random forest, some of the decision trees will choose the weight of today, the the weight of yesterday, both or another none of these two as a split criteria.  

The second does seem to play a role in case of PFI. If the features are correlated it can happen in the step of shuffling on of the features that there are unrealistic instances of data points. In this case it breaks not only the association to the outcome variable, but also the association with the correlated feature. For instance, there exists the variable indicating the amount of precipitation and an other variable indicating the weather. Shuffling the the variable precipitation can lead to data instances where the precipitation is high and the weather is sunny. So there are cases where the new data points are unlikely all the way up to completely impossible. The question is can we still trust the informative value of the PFI, if it is calculated with data instances that are not observed in reality and therefore biased?

This chapter demonstrates some issue of correlated features and tries to present some reasons of the outcomes. This is done by looking at the behaviour of PFI and LOCO Feature Importance when the feature of the given data set are correlated with each other. To get a better understanding there will be a change in the intensity of the correlation of the features and in the learning algorithms. 

## Effect on Feature Importance by Adding Correlated Features

In this chapter we want to take a closer look at the problem of the interpretation of Feature Importance by adding or having correlated features in the given data set. Our focus is on the behaviour of Permutation Feature Importance by Breiman as well as of the LOCO Feature Importance by Lei et. which have been already introduced. There will be a comparison of these measures apllied on the linear model and random forest model with different correlation intesities using simulations. Later on an application of a real data set (Boston?) will follow. 

### Simulation

A good way to show the effects of correlated features on the feature importance measures is just to simulate some data with the desired dependence. This allows us to show the effects on the PFI and LOCO feature Importance more precise than looking on a real data set where additional dependencies between each features exist. The main focus is here on the simulation of correlated feature and not the application on real data, because the features of real data are most of the time correlated with different kind of intesity among one another. To filter out the real effect it is neccessary to hold the influence of other features as small as possible, so there will be no misinterpretations. 
In total there will be four different scenario settings to investigate the influence of correlated features on the PFI and LOCO. The following setup is used as a general baseline for scenario 1-3 and the fourth differs to the extent that there will be more feature involved: 
$$
y_{i} = x_{i1}+x_{i2}+x_{i3}+x_{i4}+\epsilon_{i}
$$

Here we want to investigate the effect on PFI and LOCO Feature Importance of the correlated features with different kind of dependencies on the target value y. There are four features of which two ($X1$ and $X2$) show different correlaion intensities $\rho$ betweeen each other. Otherwise, there is no correlation between any feature. Only in scenario 4) the setting changes to more features and more correlations to investigate the behaviour, if there is an increase in the features which are correlated.

**The simulation design of different correlation intensities**

In order to examine the effect we simulated a fictive data set with four features $x_{i1}...x_{i4}$ and 1000 observation $i = 1,...,1000$. The features were randomly drawn out of a multivariate normal distribution with a mean of 0 $X \sim MVN(0,\Sigma)$. The covariance $\Sigma$ depends on the variance of all features which were set equally to $\sigma_{j,j}=1$ and covariance $\sigma_{j,l}$. The covariance for feature 1 and 2 $\sigma_{1,2}$ were set to either $\rho = 0;0,25;0,5;0,75 or 0,99$ depending on our intesity of interest whereas the covariance of the rest were set to $\sigma_{j,l} = 0$ which means independence. Note: Here the correlaion and the covariance are the same, because we set the variance to 1 such that $\rho = \frac{Cov(X_{j},X_{l})}{\sqrt{Var(X_{j})}\sqrt{Var(X_{l})}} =Cov(X_{j},X_{l})$. The reason behind we setting $\rho = 0.99$ and not to $1$ is that to avoid problems to calculate matrices. If $\rho = 1$ we have perfect multicollinearity and the problem that the rank of the matrix is not full. So this simplifies later calculations especially regarding the application of the linear model.

Quelle: Archer and Kimes, Strobl 2008

* added a random variable to see if the importance is higher than a random effect
  
**Simulation of uncorrelated feature 1 and 2 (r = 0):**

```{r Simulation01, message = FALSE, eval=FALSE, fig.height=6, fig.width=12, fig.cap= "Simulation of uncorrelated features 1 and 2 (r=0)"}
library(mvtnorm)
library(matrixcalc)
set.seed(456)
# Specify entries for covariance matrix
sigma_u <- diag(1, nrow = 4)
# Simulate data from multivariate normal distribution 
data_u <- as.data.frame(rmvnorm(n = 1000, 
                              mean = rep(0, times = 4), 
                              sigma = sigma_u))
colnames(data_u) <- c("X1", "X2", "X3", "X4")
# Check positive definit covariance and correlation matrices
cov(data_u)
is.positive.definite(cov(data_u))
cor(data_u)
is.positive.definite(cor(data_u))
# Added random feature
data_u <- as.data.frame(data_u)
data_u['random'] <- runif(nrow(data_u))
```

```{r Simulation02, message = FALSE, eval = FALSE , echo=FALSE, fig.height=6, fig.width=12, fig.cap="Simulation of correlated features 1 and 2 (r=0.25) "}

library(mvtnorm)
library(matrixcalc)

set.seed(456)
# specify entries for covariance matrix
sigma_c25 <- diag(1, nrow = 4)
sigma_c25[1,2] <-  0.25
sigma_c25[2,1] <- 0.25
# simulate data from normal distribution 
data_c25 <- as.data.frame(rmvnorm(n = 1000, 
                              mean = rep(0, times = 4), 
                              sigma = sigma_c25))
colnames(data_c25) <- c("X1", "X2", "X3", "X4")
# check covariance and correlation matrices 
cov(data_c25)
is.positive.definite(cov(data_c25))

cor(data_c25)
is.positive.definite(cor(data_c25))

data_c25 <- as.data.frame(data_c25)
data_c25['random'] <- runif(nrow(data_c25))
```

```{r Simulation03, message = FALSE, eval = FALSE, echo=FALSE,fig.height=6, fig.width=12, fig.cap="Simulation of medium correlated features 1 and 2 (r=0.5) "}

library(mvtnorm)
library(matrixcalc)

set.seed(456)
# specify entries for covariance matrix
sigma_c5 <- diag(1, nrow = 4)
sigma_c5[1,2] <-  0.5
sigma_c5[2,1] <- 0.5
# simulate data from normal distribution 
data_c5 <- as.data.frame(rmvnorm(n = 1000, 
                              mean = rep(0, times = 4), 
                              sigma = sigma_c5))
colnames(data_c5) <- c("X1", "X2", "X3", "X4")
# check covariance and correlation matrices 
cov(data_c5)
is.positive.definite(cov(data_c5))

cor(data_c5)
is.positive.definite(cor(data_c5))

data_c5 <- as.data.frame(data_c5)
data_c5['random'] <- runif(nrow(data_c5))
```

```{r Simulation04, message = FALSE, eval = FALSE ,echo=FALSE, fig.height=6, fig.width=12, fig.cap="Simulation of high correlated features 1 and 2 (r=0.75) "}

library(mvtnorm)
library(matrixcalc)

set.seed(456)
# specify entries for covariance matrix
sigma_c75 <- diag(1, nrow = 4)
sigma_c75[1,2] <-  0.75
sigma_c75[2,1] <- 0.75
# simulate data from normal distribution 
data_c75 <- as.data.frame(rmvnorm(n = 1000, 
                              mean = rep(0, times = 4), 
                              sigma = sigma_c75))
colnames(data_c75) <- c("X1", "X2", "X3", "X4")
# check covariance and correlation matrices 
cov(data_c75)
is.positive.definite(cov(data_c75))

cor(data_c75)
is.positive.definite(cor(data_c75))

data_c75 <- as.data.frame(data_c75)
data_c75['random'] <- runif(nrow(data_c75))
```

```{r Simulation05, message = FALSE, eval = FALSE ,echo=FALSE, fig.height=6, fig.width=12, fig.cap="Simulation of complete correlated features 1 and 2 (r=0.99) "}

library(mvtnorm)
library(matrixcalc)

set.seed(456)
# specify entries for covariance matrix
sigma_c <- diag(1, nrow = 4)
sigma_c[1,2] <-  0.99
sigma_c[2,1] <- 0.99
# simulate data from normal distribution 
data_c <- as.data.frame(rmvnorm(n = 1000, 
                              mean = rep(0, times = 4), 
                              sigma = sigma_c))
colnames(data_c) <- c("X1", "X2", "X3", "X4")
# check covariance and correlation matrices 
cov(data_c)
is.positive.definite(cov(data_c))

cor(data_c)
is.positive.definite(cor(data_c))

data_c <- as.data.frame(data_c)
data_c['random'] <- runif(nrow(data_c))
```


**Scenario Settings:**

(only the scenarios which show interesting results will be shown later). There are many interesting instances.  

**1) Linear Dependence:**


$$
y_{i} = x_{i1}+x_{i2}+x_{i3}+x_{i4}+\epsilon_{i}
$$


In the first scenario setting the dependence of the features $X_i$ on the target value $y$ is a linear one. 

The choice of noise variance $sd_i^2$ should be hold small in order to make the behavior we observe clearer and there will be no misinterpretation. In this case we assume that there is only a standard deviation of ten percent of the mean of the [...].


```{r szenariolm, message = FALSE, eval = FALSE , fig.height=6, fig.width=12, fig.cap="Szenario Linear Dependence with differrent correlation of feature 1 and 2"}

sd_u <- mean(data_u$X1 + data_u$X2 + data_u$X3 + data_u$X4)*0.1
sd_c25 <- mean(data_c25$X1 + data_c25$X2 + data_c25$X3 + data_c25$X4)*0.1
sd_c5 <- mean(data_c5$X1 + data_c5$X2 + data_c5$X3 + data_c5$X4)*0.1
sd_c75 <- mean(data_c75$X1 + data_c75$X2 + data_c75$X3 + data_c75$X4)*0.1
sd_c <- mean(data_c$X1 + data_c$X2 + data_c$X3 + data_c$X4)*0.1

#The choice of noise variance should be hold small in order to make the behavior we observe clearer and there will be no misinterpretation.

y1u <- data_u$X1 + data_u$X2 + data_u$X3 + data_u$X4 + rnorm(n = 1000, mean = 0, sd = sd_u) 
y1c25 <- data_c25$X1 + data_c25$X2 + data_c25$X3 + data_c25$X4 + rnorm(n = 1000, mean = 0, sd = sd_c25)
y1c5 <- data_c5$X1 + data_c5$X2 + data_c5$X3 + data_c5$X4 + rnorm(n = 1000, mean = 0, sd = sd_c5)
y1c75 <- data_c75$X1 + data_c75$X2 + data_c75$X3 + data_c75$X4 + rnorm(n = 1000, mean = 0, sd = sd_c75)
y1c <- data_c$X1 + data_c$X2 + data_c$X3 + data_c$X4 + rnorm(n = 1000, mean = 0, sd = sd_c) 


data_u["y1u"] <- y1u
data_c25["y1c25"] <- y1c25
data_c5["y1c5"] <- y1c5
data_c75["y1c75"] <- y1c75
data_c["y1c"] <- y1c
```

```{r PFIAlgo, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap= "PFI Algo"}

PFI <- function(data,learner,target,model){
  d <- data
  task = makeRegrTask(data = data , target= target)
  learnerPFI = makeLearner(learner)
  res = resample(learner = learnerPFI, task = task, 
                   resampling = res_desc,show.info = FALSE, models = TRUE)
  resultPFI <- data.frame(matrix(nrow=5,ncol=1))
  rankPFI <- data.frame(matrix(nrow=5,ncol=1))
  for(i in 1:10){
    mod <- Predictor$new(res$models[[i]]$learner.model,
                           data=d[c(res$pred$instance$test.inds[[i]]),1:5], 
                           y = d[c(res$pred$instance$test.inds[[i]]),6])
    
    imp <- FeatureImp$new(mod, loss = "mse" , compare = "ratio")
    impo <- imp$results
    impo <- impo[order(impo$feature),]
    resultPFI[i] <- data.frame(impo$importance)
    rankPFI[i] <- data.frame(rank(-resultPFI[i]))
  }
  imp.dat <- data.frame(rowSums(resultPFI)/10)
  rank.dat <- data.frame(rowSums(rankPFI)/10)
  imp.dat["features"]<- impo$feature
  imp.dat["averagerank"]<- rank.dat
  imp.dat["rank"] <- rank(-rowSums(resultPFI)/10)
  colnames(imp.dat) <- c("importance","features","averagerank", "rank")
  return(imp.dat)
}
```

```{r LOCOAlgo, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap= "LOCO Algo"}
library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

LOCO <- function(data,learner,target){
  d <- data
  task = makeRegrTask(data = data , target= target)
  learnerLOCO = makeLearner(learner)
  feat = getTaskFeatureNames(task)
  res = resample(learner = learnerLOCO, task = task, 
               resampling = res_desc,show.info = FALSE)
  resultLOCO <- data.frame(matrix(nrow=1,ncol=length(feat))) 
  for(i in 1:length(feat)){
  taskfeat = dropFeatures(task, feat[i])
  mod.feat = train(learnerLOCO, dropFeatures(task, feat[i]))
  resfeat = resample(learner = learnerLOCO, task = taskfeat, resampling = res_desc ,show.info = FALSE);
  importance = data.frame(resfeat$aggr/res$aggr)
  feature = c(getTaskFeatureNames(task))
  resultLOCO[i] <- importance
  #print(importance)
}
resultLOCO
rownames(resultLOCO) <- "importance"
FIP <- data.frame(
  importance= t(resultLOCO),
  feature= getTaskFeatureNames(task))
return(FIP)
}
```


```{r PFI01, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap= "PFI with different correlations of features 1 and 2 on a random forest model"}

library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

rfu <- randomForest(y1u~. , data = data_u)
rfc25 <- randomForest(y1c25~. , data = data_c25)
rfc5 <- randomForest(y1c5~. , data = data_c5)
rfc75 <- randomForest(y1c75~. , data = data_c75)
rfc <- randomForest(y1c~. , data = data_c)

rfPFIu <- PFI(data_u, "regr.randomForest", "y1u" , rfu)
rfPFIc25 <- PFI(data_c25, "regr.randomForest", "y1c25" , rfc25)
rfPFIc5 <- PFI(data_c5, "regr.randomForest", "y1c5" , rfc5)
rfPFIc75 <- PFI(data_c75, "regr.randomForest", "y1c75" , rfc75)
rfPFIc <- PFI(data_c, "regr.randomForest", "y1c" , rfc)

prf <- ggplot(rfPFIu, aes(x=features, y= importance, colour = "0")) +
    geom_point(mapping=aes(x=features, y=importance), size=0, stroke = 3, shape=21, fill="white") +
    geom_point(mapping=aes(x=rfPFIc25$features, y=rfPFIc25$importance, colour = "0.25"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=rfPFIc5$features, y=rfPFIc5$importance, colour = "0.5"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=rfPFIc75$features, y=rfPFIc75$importance, colour = "0.75"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=rfPFIc$features, y=rfPFIc$importance, colour = "0.99"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    coord_flip() +
    theme(plot.subtitle = element_text(size = 10)) +
    labs(y = "Feature Importance MSE", x= "") + 
    theme(text = element_text(size = 14))+
    scale_color_manual(labels = c("0","0.25","0.5","0.75","0.99"), values=c("0" = "white", "0.25" = "lightblue", "0.5"= "blue", "0.75"="darkblue", "0.99" = "black"), name = "Correlation Intensity",breaks=c("0", "0.25", "0.5", "0.75", "0.99"))+
    ggtitle("PFI on Random Forest")

prf

```

```{r PFI02, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap="PFI with different correlations of features 1 and 2 on a linear model"}

library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

lmu <- lm(y1u~., data=data_u)
lmc25 <- lm(y1c25~., data = data_c25)
lmc5 <- lm(y1c5~., data = data_c5)
lmc75 <- lm(y1c75~., data = data_c75)
lmc <- lm(y1c~., data = data_c)

lmPFIu <- PFI(data_u, "regr.lm", "y1u" , lmu)
lmPFIc25 <- PFI(data_c25, "regr.lm", "y1c25" , lmc25)
lmPFIc5 <- PFI(data_c5, "regr.lm", "y1c5" , lmc5)
lmPFIc75 <- PFI(data_c75, "regr.lm", "y1c75" , lmc75)
lmPFIc <- PFI(data_c, "regr.lm", "y1c" , lmc)


#Plot:
plm <- ggplot(lmPFIu, aes(x=features, y= importance, colour = "0")) +
    geom_point(mapping=aes(x=features, y=importance), size=0, stroke = 3, shape=21, fill="white") +
    geom_point(mapping=aes(x=lmPFIc25$features, y=lmPFIc25$importance, colour = "0.25"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=lmPFIc5$features, y=lmPFIc5$importance, colour = "0.5"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=lmPFIc75$features, y=lmPFIc75$importance, colour = "0.75"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=lmPFIc$features, y=lmPFIc$importance, colour = "0.99"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    coord_flip() +
    theme(plot.subtitle = element_text(size = 10)) +
    labs(y = "Feature Importance MSE", x= "") + 
    theme(text = element_text(size = 14))+
    scale_color_manual(labels = c("0","0.25","0.5","0.75","0.99"), values=c("0" = "white", "0.25" = "lightblue", "0.5"= "blue", "0.75"="darkblue", "0.99" = "black"), name = "Correlation Intensity",breaks=c("0", "0.25", "0.5", "0.75", "0.99"))+
    ggtitle("PFI on Linear Model")

plm
```





```{r LOCO01, message = FALSE,eval = FALSE , fig.height=6, fig.width=12, fig.cap= "LOCO Feature Importance with different kind of correlation intensity on a random forest model"}
library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

rfLOCOua <- LOCO(data_u, "regr.randomForest", "y1u")
rfLOCOc25a <- LOCO(data_c25, "regr.randomForest", "y1c25")
rfLOCOc5a <- LOCO(data_c5, "regr.randomForest", "y1c5")
rfLOCOc7a <- LOCO(data_c75, "regr.randomForest", "y1c75")
rfLOCOca <- LOCO(data_c, "regr.randomForest", "y1c")

#Plot:
ploco <- ggplot(data = rfLOCOua ,aes(x=feature,y = importance, colour = "0")) + #### hier fehler 
  geom_point(mapping=aes(x=feature, y=importance), size=0, shape=21,stroke = 3, fill="white") +
  geom_point(mapping=aes(x=rfLOCOc25a$feature, y=rfLOCOc25a$importance, colour = "0.25"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=rfLOCOc5a$feature, y=rfLOCOc5a$importance, colour = "0.5"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=rfLOCOc75a$feature, y=rfLOCOc75a$importance, colour = "0.75"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=rfLOCOca$feature, y=rfLOCOca$importance, colour = "0.99"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
  coord_flip() +
  theme(plot.subtitle = element_text(size = 10)) +
  labs(y = "Feature Importance MSE", x= "") + 
  theme(text = element_text(size = 14))+
  scale_color_manual(labels = c("0","0.25","0.5","0.75","0.99"), values=c("0" = "white", "0.25" = "lightblue", "0.5"= "blue", "0.75"="darkblue", "0.99" = "black"), name = "Correlation Intensity",breaks=c("0", "0.25", "0.5", "0.75", "0.99"))+
  ggtitle("LOCO on Random Forest")

ploco

```


```{r LOCO02, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap="LOCO Feature Importance with different kind of correlation intensity on a linear model"}
library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

lmLOCOua <- LOCO(data_u, "regr.lm", "y1u")
lmLOCOc25a <- LOCO(data_c25, "regr.lm", "y1c25")
lmLOCOc5a <- LOCO(data_c5, "regr.lm", "y1c5")
lmLOCOc75a <- LOCO(data_c75, "regr.lm", "y1c75")
lmLOCOca <- LOCO(data_c, "regr.lm", "y1c")

#Plot:
plocolm <- ggplot(data = lmLOCOua ,aes(x=featureu,y = importance_u, colour = "0")) + #### hier fehler 
  geom_point(mapping=aes(x=feature, y=importance), size=0, shape=21,stroke = 3, fill="white") +
  geom_point(mapping=aes(x=lmLOCOc25a$feature, y=lmLOCOc25a$importance, colour = "0.25"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=lmLOCOc5a$feature, y=lmLOCOc5a$importance, colour = "0.5"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=lmLOCOc75a$feature, y=lmLOCOc75a$importance, colour = "0.75"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=lmLOCOca$feature, y=lmLOCOca$importance, colour = "0.99"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
  coord_flip() +
  theme(plot.subtitle = element_text(size = 10)) +
  labs(y = "Feature Importance MSE", x= "") + 
  theme(text = element_text(size = 14))+
  scale_color_manual(labels = c("0","0.25","0.5","0.75","0.99"), values=c("0" = "white", "0.25" = "lightblue", "0.5"= "blue", "0.75"="darkblue", "0.99" = "black"), name = "Correlation Intensity",breaks=c("0", "0.25", "0.5", "0.75", "0.99"))+
  ggtitle("LOCO on Linear Model")

plocolm
```


```{r arrange01, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap= "Comparison"}
library(ggpubr)
ggarrange(prf, plm, ploco, plocolm , ncol=2, nrow = 2, legend = "bottom", common.legend = TRUE)
``` 


**2) Nonlinear Dependence:**

$$
y_{i} = sin(x_{i1})+x_{i2}+sin(x_{i3})+x_{i4}+\epsilon_{i}
$$


In the second scenario there is no pure linear relationship between the target value $y$ and the features $X_{i}$. Here $X_{1}$ has a non linear dependence in form of the sine function. 

```{r scenariononnld, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap=" Simulation of Nonlinear Dependence"}


sd2_u <- mean(sin(data_u$X1) + data_u$X2 + sin(data_u$X3) + data_u$X4)*0.1

sd2_c25 <- mean(sin(data_c25$X1) + data_c25$X2 + sin(data_c25$X3) + data_c25$X4)*0.1

sd2_c5 <- mean(sin(data_c5$X1) + data_c5$X2 + sin(data_c5$X3) + data_c5$X4)*0.1

sd2_c75 <- mean(sin(data_c75$X1) + data_c75$X2 + sin(data_c75$X3) + data_c75$X4)*0.1

sd2_c <- mean(sin(data_c$X1) + data_c$X2 + sin(data_c$X3) + data_c$X4)*0.1


y2u <- sin(data_u$X1) + data_u$X2 + sin(data_u$X3) + data_u$X4 + rnorm(n = 1000, mean = 0, sd = sd2_u) 

y2c25 <- sin(data_c25$X1) + data_c25$X2 + sin(data_c25$X3) + data_c25$X4 + rnorm(n = 1000, mean = 0, sd = sd2_c25)

y2c5 <- sin(data_c5$X1) + data_c5$X2 + sin(data_c5$X3) + data_c5$X4 + rnorm(n = 1000, mean = 0, sd = sd2_c5)

y2c75 <- sin(data_c75$X1) + data_c75$X2 + sin(data_c75$X3) + data_c75$X4 + rnorm(n = 1000, mean = 0, sd = sd2_c75)

y2c <- sin(data_c$X1) + data_c$X2 + sin(data_c$X3) + data_c$X4 + rnorm(n = 1000, mean = 0, sd = sd2_c)  

data_u$y1u <- NULL
data_u["y2u"] <- y2u
data_c25$y1c25 <- NULL
data_c25["y2c25"] <- y2c25
data_c5$y1c5 <- NULL
data_c5["y2c5"] <- y2c5
data_c75$y1c75 <- NULL
data_c75["y2c75"] <- y2c75
data_c$y1c <- NULL
data_c["y2c"] <- y2c
```  


```{r PFI03, message = FALSE, fig.height=6, eval = FALSE , fig.width=12, fig.cap= "PFI with different correlations of features 1 and 2 on a random forest"}
library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

rfub <- randomForest(y2u~. , data = data_u)
rfc25b <- randomForest(y2c25~. , data = data_c25)
rfc5b <- randomForest(y2c5~. , data = data_c5)
rfc75b <- randomForest(y2c75~. , data = data_c75)
rfcb <- randomForest(y2c~. , data = data_c)

rf2PFIu <- PFI(data_u, "regr.randomForest", "y2u" , rfub)
rf2PFIc25 <- PFI(data_c25, "regr.randomForest", "y2c25" , rfc25b)
rf2PFIc5 <- PFI(data_c5, "regr.randomForest", "y2c5" , rfc5b)
rf2PFIc75 <- PFI(data_c75, "regr.randomForest", "y2c75" , rfc75b)
rf2PFIc <- PFI(data_c, "regr.randomForest", "y2c" , rfcb)

prf <- ggplot(rf2PFIu, aes(x=features, y= importance, colour = "0")) +
    geom_point(mapping=aes(x=features, y=importance), size=0, stroke = 3, shape=21, fill="white") +
    geom_point(mapping=aes(x=rf2PFIc25$features, y=rf2PFIc25$importance, colour = "0.25"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=rf2PFIc5$features, y=rf2PFIc5$importance, colour = "0.5"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=rf2PFIc75$features, y=rf2PFIc75$importance, colour = "0.75"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=rf2PFIc$features, y=rf2PFIc$importance, colour = "0.99"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    coord_flip() +
    theme(plot.subtitle = element_text(size = 10)) +
    labs(y = "Feature Importance MSE", x= "") + 
    theme(text = element_text(size = 14))+
    scale_color_manual(labels = c("0","0.25","0.5","0.75","0.99"), values=c("0" = "white", "0.25" = "lightblue", "0.5"= "blue", "0.75"="darkblue", "0.99" = "black"), name = "Correlation Intensity",breaks=c("0", "0.25", "0.5", "0.75", "0.99"))+
    ggtitle("PFI on Random Forest")

prf
```


```{r PFI04, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap="PFI with different correlations of features 1 and 2 on a linear model"}

library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

lmub <- lm(y2u~., data=data_u)
lmc25b <- lm(y2c25~., data = data_c25)
lmc5b <- lm(y2c5~., data = data_c5)
lmc75b <- lm(y2c75~., data = data_c75)
lmcb <- lm(y2c~., data = data_c)

lm2PFIu <- PFI(data_u, "regr.lm", "y2u" , lmub)
lm2PFIc25 <- PFI(data_c25, "regr.lm", "y2c25" , lmc25b)
lm2PFIc5 <- PFI(data_c5, "regr.lm", "y2c5" , lmc5b)
lm2PFIc75 <- PFI(data_c75, "regr.lm", "y2c75" , lmc75b)
lm2PFIc <- PFI(data_c, "regr.lm", "y2c" , lmcb)


#Plot:
plm <- ggplot(lmPFIu, aes(x=features, y= importance, colour = "0")) +
    geom_point(mapping=aes(x=features, y=importance), size=0, stroke = 3, shape=21, fill="white") +
    geom_point(mapping=aes(x=lmPFIc25$features, y=lmPFIc25$importance, colour = "0.25"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=lmPFIc5$features, y=lmPFIc5$importance, colour = "0.5"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=lmPFIc75$features, y=lmPFIc75$importance, colour = "0.75"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=lmPFIc$features, y=lmPFIc$importance, colour = "0.99"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    coord_flip() +
    theme(plot.subtitle = element_text(size = 10)) +
    labs(y = "Feature Importance MSE", x= "") + 
    theme(text = element_text(size = 14))+
    scale_color_manual(labels = c("0","0.25","0.5","0.75","0.99"), values=c("0" = "white", "0.25" = "lightblue", "0.5"= "blue", "0.75"="darkblue", "0.99" = "black"), name = "Correlation Intensity",breaks=c("0", "0.25", "0.5", "0.75", "0.99"))+
    ggtitle("PFI on Linear Model")

plm

```

```{r LOCO03, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap="LOCO Feature Importance with different kind of correlation intensity on a random forest model"}
rfLOCOu <- LOCO(data_u, "regr.randomForest", "y2u")
rfLOCOc25 <- LOCO(data_c25, "regr.randomForest", "y2c25")
rfLOCOc5 <- LOCO(data_c5, "regr.randomForest", "y2c5")
rfLOCOc75 <- LOCO(data_c75, "regr.randomForest", "y2c75")
rfLOCOc <- LOCO(data_c, "regr.randomForest", "y2c")

#Plot:
ploco <- ggplot(data = rfLOCOu ,aes(x=featureu,y = importance_u, colour = "0")) + #### hier fehler 
  geom_point(mapping=aes(x=feature, y=importance), size=0, shape=21,stroke = 3, fill="white") +
  geom_point(mapping=aes(x=rfLOCOc25$feature, y=rfLOCOc25$importance, colour = "0.25"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=rfLOCOc5$feature, y=rfLOCOc5$importance, colour = "0.5"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=rfLOCOc75$feature, y=rfLOCOc75$importance, colour = "0.75"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=rfLOCOc$feature, y=rfLOCOc$importance, colour = "0.99"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
  coord_flip() +
  theme(plot.subtitle = element_text(size = 10)) +
  labs(y = "Feature Importance MSE", x= "") + 
  theme(text = element_text(size = 14))+
  scale_color_manual(labels = c("0","0.25","0.5","0.75","0.99"), values=c("0" = "white", "0.25" = "lightblue", "0.5"= "blue", "0.75"="darkblue", "0.99" = "black"), name = "Correlation Intensity",breaks=c("0", "0.25", "0.5", "0.75", "0.99"))+
  ggtitle("LOCO on Random Forest")

ploco
```


```{r LOCO04, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap="LOCO Feature Importance with different kind of correlation intensity on a linear model"}
library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

lmLOCOu <- LOCO(data_u, "regr.lm", "y2u")
lmLOCOc25 <- LOCO(data_c25, "regr.lm", "y2c25")
lmLOCOc5 <- LOCO(data_c5, "regr.lm", "y2c5")
lmLOCOc75 <- LOCO(data_c75, "regr.lm", "y2c75")
lmLOCOc <- LOCO(data_c, "regr.lm", "y2c")

#Plot:
plocolm <- ggplot(data = lmLOCOu ,aes(x=featureu,y = importance_u, colour = "0")) + #### hier fehler 
  geom_point(mapping=aes(x=feature, y=importance), size=0, shape=21,stroke = 3, fill="white") +
  geom_point(mapping=aes(x=lmLOCOc25$feature, y=lmLOCOc25$importance, colour = "0.25"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=lmLOCOc5$feature, y=lmLOCOc5$importance, colour = "0.5"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=lmLOCOc75$feature, y=lmLOCOc75$importance, colour = "0.75"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=lmLOCOc$feature, y=lmLOCOc$importance, colour = "0.99"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
  coord_flip() +
  theme(plot.subtitle = element_text(size = 10)) +
  labs(y = "Feature Importance MSE", x= "") + 
  theme(text = element_text(size = 14))+
  scale_color_manual(labels = c("0","0.25","0.5","0.75","0.99"), values=c("0" = "white", "0.25" = "lightblue", "0.5"= "blue", "0.75"="darkblue", "0.99" = "black"), name = "Correlation Intensity",breaks=c("0", "0.25", "0.5", "0.75", "0.99"))+
  ggtitle("LOCO on Linear Model")
```


```{r arrange02, message = FALSE, eval = FALSE , fig.height=6, fig.width=12, fig.cap= "Comparison"}
library(ggpubr)
ggarrange(prf, plm, ploco, plocolm , ncol=2, nrow = 2, legend = "bottom", common.legend = TRUE)
``` 


**3) Uninformative Feature:**
Uninformative which means that one feature (in this case X4) is considered for the dependence on Y, but not considered for the model. So here it is the same case as in 1)

```{r szenariouif, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap= "Scenario Linear Dependence with uninformative feature 4"}

sd3_u <- mean(data_u$X1 + data_u$X2 + data_u$X3 + data_u$X4)*0.1

sd3_c25 <- mean(data_c25$X1 + data_c25$X2 + data_c25$X3 + data_c25$X4)*0.1

sd3_c5 <- mean(data_c5$X1 + data_c5$X2 + data_c5$X3 + data_c5$X4)*0.1

sd3_c75 <- mean(data_c75$X1 + data_c75$X2 + data_c75$X3 + data_c75$X4)*0.1

sd3_c <- mean(data_c$X1 + data_c$X2 + data_c$X3 + data_c$X4)*0.1



y3u <- data_u$X1 + data_u$X2 + data_u$X3 + data_u$X4 + rnorm(n = 1000, mean = 0, sd = sd3_u) 

y3c25 <- data_c25$X1 + data_c25$X2 + data_c25$X3 + data_c25$X4 + rnorm(n = 1000, mean = 0, sd = sd3_c25)

y3c5 <- data_c5$X1 + data_c5$X2 + data_c5$X3 + data_c5$X4 + rnorm(n = 1000, mean = 0, sd = sd3_c5)

y3c75 <- data_c75$X1 + data_c75$X2 + data_c75$X3 + data_c75$X4 + rnorm(n = 1000, mean = 0, sd = sd3_c75)

y3c <- data_c$X1 + data_c$X2 + data_c$X3 + data_c$X4 + rnorm(n = 1000, mean = 0, sd = sd3_c)


data_u$y2u <- NULL
data_u["y3u"] <- y3u
data_c25$y2c25 <- NULL
data_c25["y3c25"] <- y3c25
data_c5$y2c5 <- NULL
data_c5["y3c5"] <- y3c5
data_c75$y2c75 <- NULL
data_c75["y3c75"] <- y3c75
data_c$y2c <- NULL
data_c["y3c"] <- y3c

```

```{r PFI05, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap="PFI with different correlations of features 1 and 2 on a random forest model"}

library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

rfuc <- randomForest(y3u~. , data = data_u)
rfc25c <- randomForest(y3c25~. , data = data_c25)
rfc5c <- randomForest(y3c5~. , data = data_c5)
rfc75c <- randomForest(y3c75~. , data = data_c75)
rfcc <- randomForest(y3c~. , data = data_c)

rf3PFIu <- PFI(data_u, "regr.randomForest", "y3u" , rfuc)
rf3PFIc25 <- PFI(data_c25, "regr.randomForest", "y3c25" , rfc25c)
rf3PFIc5 <- PFI(data_c5, "regr.randomForest", "y3c5" , rfc5c)
rf3PFIc75 <- PFI(data_c75, "regr.randomForest", "y3c75" , rfc75c)
rf3PFIc <- PFI(data_c, "regr.randomForest", "y3c" , rfcc)

prf <- ggplot(rf3PFIu, aes(x=features, y= importance, colour = "0")) +
    geom_point(mapping=aes(x=features, y=importance), size=0, stroke = 3, shape=21, fill="white") +
    geom_point(mapping=aes(x=rf3PFIc25$features, y=rf3PFIc25$importance, colour = "0.25"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=rf3PFIc5$features, y=rf3PFIc5$importance, colour = "0.5"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=rf3PFIc75$features, y=rf3PFIc75$importance, colour = "0.75"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=rf3PFIc$features, y=rf3PFIc$importance, colour = "0.99"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    coord_flip() +
    theme(plot.subtitle = element_text(size = 10)) +
    labs(y = "Feature Importance MSE", x= "") + 
    theme(text = element_text(size = 14))+
    scale_color_manual(labels = c("0","0.25","0.5","0.75","0.99"), values=c("0" = "white", "0.25" = "lightblue", "0.5"= "blue", "0.75"="darkblue", "0.99" = "black"), name = "Correlation Intensity",breaks=c("0", "0.25", "0.5", "0.75", "0.99"))+
    ggtitle("PFI on Random Forest")

prf
```

```{r PFI06, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap="PFI with different correlations of features 1 and 2 on a linear model"}

library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

lmuc <- lm(y3u~., data=data_u)
lmc25c <- lm(y3c25~., data = data_c25)
lmc5c <- lm(y3c5~., data = data_c5)
lmc75c <- lm(y3c75~., data = data_c75)
lmcc <- lm(y3c~., data = data_c)

lm3PFIu <- PFI(data_u, "regr.lm", "y3u" , lmuc)
lm3PFIc25 <- PFI(data_c25, "regr.lm", "y3c25" , lmc25c)
lm3PFIc5 <- PFI(data_c5, "regr.lm", "y3c5" , lmc5c)
lm3PFIc75 <- PFI(data_c75, "regr.lm", "y3c75" , lmc75c)
lm3PFIc <- PFI(data_c, "regr.lm", "y3c" , lmcc)


#Plot:
plm <- ggplot(lm3PFIu, aes(x=features, y= importance, colour = "0")) +
    geom_point(mapping=aes(x=features, y=importance), size=0, stroke = 3, shape=21, fill="white") +
    geom_point(mapping=aes(x=lm3PFIc25$features, y=lm3PFIc25$importance, colour = "0.25"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=lm3PFIc5$features, y=lm3PFIc5$importance, colour = "0.5"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=lm3PFIc75$features, y=lm3PFIc75$importance, colour = "0.75"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    geom_point(mapping=aes(x=lm3PFIc$features, y=lm3PFIc$importance, colour = "0.99"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
    coord_flip() +
    theme(plot.subtitle = element_text(size = 10)) +
    labs(y = "Feature Importance MSE", x= "") + 
    theme(text = element_text(size = 14))+
    scale_color_manual(labels = c("0","0.25","0.5","0.75","0.99"), values=c("0" = "white", "0.25" = "lightblue", "0.5"= "blue", "0.75"="darkblue", "0.99" = "black"), name = "Correlation Intensity",breaks=c("0", "0.25", "0.5", "0.75", "0.99"))+
    ggtitle("PFI on Linear Model")

plm

```



```{r LOCO05, message = FALSE,eval = FALSE , fig.height=6, fig.width=12, fig.cap="LOCO Feature Importance with different kind of correlation intensity on a random forest model"}
library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

rfLOCOu <- LOCO(data_u, "regr.randomForest", "y3u")
rfLOCOc25 <- LOCO(data_c25, "regr.randomForest", "y3c25")
rfLOCOc5 <- LOCO(data_c5, "regr.randomForest", "y3c5")
rfLOCOc75 <- LOCO(data_c75, "regr.randomForest", "y3c75")
rfLOCOc <- LOCO(data_c, "regr.randomForest", "y3c")

#Plot:
ploco <- ggplot(data = rfLOCOu ,aes(x=featureu,y = importance_u, colour = "0")) + #### hier fehler 
  geom_point(mapping=aes(x=feature, y=importance), size=0, shape=21,stroke = 3, fill="white") +
  geom_point(mapping=aes(x=rfLOCOc25$feature, y=rfLOCOc25$importance, colour = "0.25"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=rfLOCOc5$feature, y=rfLOCOc5$importance, colour = "0.5"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=rfLOCOc75$feature, y=rfLOCOc75$importance, colour = "0.75"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=rfLOCOc$feature, y=rfLOCOc$importance, colour = "0.99"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
  coord_flip() +
  theme(plot.subtitle = element_text(size = 10)) +
  labs(y = "Feature Importance MSE", x= "") + 
  theme(text = element_text(size = 14))+
  scale_color_manual(labels = c("0","0.25","0.5","0.75","0.99"), values=c("0" = "white", "0.25" = "lightblue", "0.5"= "blue", "0.75"="darkblue", "0.99" = "black"), name = "Correlation Intensity",breaks=c("0", "0.25", "0.5", "0.75", "0.99"))+
  ggtitle("LOCO on Random Forest")

ploco
```




```{r LOCO06, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap="LOCO Feature Importance with different kind of correlation intensity on a linear model"}
library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

lmLOCOu <- LOCO(data_u, "regr.lm", "y3u")
lmLOCOc25 <- LOCO(data_c25, "regr.lm", "y3c25")
lmLOCOc5 <- LOCO(data_c5, "regr.lm", "y3c5")
lmLOCOc75 <- LOCO(data_c75, "regr.lm", "y3c75")
lmLOCOc <- LOCO(data_c, "regr.lm", "y3c")

#Plot:
plocolm <- ggplot(data = lmLOCOu ,aes(x=featureu,y = importance_u, colour = "0")) + #### hier fehler 
  geom_point(mapping=aes(x=feature, y=importance), size=0, shape=21,stroke = 3, fill="white") +
  geom_point(mapping=aes(x=lmLOCOc25$feature, y=lmLOCOc25$importance, colour = "0.25"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=lmLOCOc5$feature, y=lmLOCOc5$importance, colour = "0.5"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=lmLOCOc75$feature, y=lmLOCOc75$importance, colour = "0.75"), size=0,stroke = 3, shape=21, fill="white", show.legend = TRUE)+
  geom_point(mapping=aes(x=lmLOCOc$feature, y=lmLOCOc$importance, colour = "0.99"), size=0, shape=21,stroke = 3, fill="white", show.legend = TRUE)+
  coord_flip() +
  theme(plot.subtitle = element_text(size = 10)) +
  labs(y = "Feature Importance MSE", x= "") + 
  theme(text = element_text(size = 14))+
  scale_color_manual(labels = c("0","0.25","0.5","0.75","0.99"), values=c("0" = "white", "0.25" = "lightblue", "0.5"= "blue", "0.75"="darkblue", "0.99" = "black"), name = "Correlation Intensity",breaks=c("0", "0.25", "0.5", "0.75", "0.99"))+
  ggtitle("LOCO on Linear Model")

plocolm
```

```{r arrange03, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap= "Comparison"}
library(ggpubr)
ggarrange(prf, plm, ploco, plocolm , ncol=2, nrow = 2, legend = "bottom", common.legend = TRUE)
``` 



**4) Simulation with high amount of correlated data**

```{r scenariohac, message = FALSE,eval = FALSE , fig.height=6, fig.width=12, fig.cap="Simulation of 10 correlated features (r=0.99) "}

library(mvtnorm)

set.seed(456)

sigma_sim10 <- diag(1, nrow = 12)
sigma_sim10[which(sigma_sim10 != "1")] = 0.99 
sigma_sim10[11,] <- 0
sigma_sim10[,11] <- 0
sigma_sim10[12,] <- 0
sigma_sim10[,12] <- 0
sigma_sim10[11,11] <- 1
sigma_sim10[12,12] <- 1

data_sim10 <- as.data.frame(rmvnorm(n = 1000, 
                              mean = rep(0, times = 12), 
                              sigma = sigma_sim10))

data_sim10 <- as.data.frame(data_sim10)
data_sim10['random'] <- runif(nrow(data_sim10))

sigma_sim5 <- diag(1, nrow = 7)
sigma_sim5[which(sigma_sim5 != "1")] = 0.99 
sigma_sim5[6,] <- 0
sigma_sim5[,6] <- 0
sigma_sim5[7,] <- 0
sigma_sim5[,7] <- 0
sigma_sim5[6,6] <- 1
sigma_sim5[7,7] <- 1
sigma_sim5

data_sim5 <- as.data.frame(rmvnorm(n = 1000, 
                              mean = rep(0, times = 7), 
                              sigma = sigma_sim5))
head(data_sim5)


data_sim5 <- as.data.frame(data_sim5)
data_sim5['random'] <- runif(nrow(data_sim5))


colnames(data_sim5) <- c("X1", "X2", "X3", "X4","X5", "X6", "X7", "random")
colnames(data_sim10) <- c("X1", "X2", "X3", "X4","X5", "X6", "X7", "X8","X9", "X10", "X11", "X12", "random")

sd_sim5 <- mean(data_sim5$X1 + data_sim5$X2 + data_sim5$X3 + data_sim5$X4+ data_sim5$X5+ data_sim5$X6+ data_sim5$X7)*0.1

sd_sim10 <- mean(data_sim10$X1 + data_sim10$X2 + data_sim10$X3 + data_sim10$X4+ data_sim10$X5+ data_sim10$X6+ data_sim10$X7+ data_sim10$X8+ data_sim10$X9+ data_sim10$X10+ data_sim10$X11+ data_sim10$X12)*0.1

y1sim5 <- data_sim5$X1 + data_sim5$X2 + data_sim5$X3 + data_sim5$X4+ data_sim5$X5+ data_sim5$X6+ data_sim5$X7 + rnorm(n = 1000, mean = 0, sd = sd_sim5) 

y1sim10 <- data_sim10$X1 + data_sim10$X2 + data_sim10$X3 + data_sim10$X4+ data_sim10$X5+ data_sim10$X6+ data_sim10$X7+ data_sim10$X8+ data_sim10$X9+ data_sim10$X10+ data_sim10$X11+ data_sim10$X12 + rnorm(n = 1000, mean = 0, sd = sd_sim10)
```



```{r PFI07, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap="Simulation of 10 correlated features (r=0.99) "}

library(mlr)
library(iml)
library(ggplot2)
library(randomForest)

rfsim5 <- randomForest(y1sim5~. , data = data_sim5)
rfsim10 <- randomForest(y1sim10~. , data = data_sim10)


modrfsim5 <- Predictor$new(rfsim5, data=data_sim5, y = y1sim5)
modrfsim10 <- Predictor$new(rfsim10, data=data_sim10, y = y1sim10)

imprfsim5 <- FeatureImp$new(modrfsim5, loss = "mse" , compare = "ratio")
imprfsim10 <- FeatureImp$new(modrfsim10, loss = "mse" , compare = "ratio")


imp.datrfsim5 <- imprfsim5$results
imp.datrfsim10 <- imprfsim10$results

prfsim5 <- ggplot(imp.datrfsim5, aes(x=reorder(feature, importance), ymin=importance.05, ymax=importance.95)) +
  geom_errorbar(width=0.3, size=1, color="darkgreen") + 
    geom_point(mapping=aes(x=feature, y=importance), size=3, shape=21, fill="green") +
   coord_flip() +
    theme(plot.subtitle = element_text(size = 10)) +
    labs(y = "Feature Importance MSE", x= "") + 
    theme(text = element_text(size = 16))
prfsim5

prfsim10 <- ggplot(imp.datrfsim10, aes(x=reorder(feature, importance), ymin=importance.05, ymax=importance.95)) +
  geom_errorbar(width=0.3, size=1, color="darkred") +
    geom_point(mapping=aes(x=feature, y=importance), size=3, shape=21, fill="red")+
    coord_flip() +
    theme(plot.subtitle = element_text(size = 10)) +
    labs(y = "Feature Importance MSE", x= "") + 
    theme(text = element_text(size = 16)) 
prfsim10


mean(imp.datrfsim5$importance[1:5])
mean(imp.datrfsim10$importance[1:10])
```

```{r arrange04, message = FALSE,eval = FALSE , fig.height=6, fig.width=12, fig.cap= "Comparison"}
library(ggpubr)
ggarrange(prfsim5, prfsim10 , ncol=2, legend = "bottom", common.legend = TRUE)
``` 


```{r LOCO07, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, echo = FALSE, eval=FALSE, fig.cap="LOCO Feature Importance with different kind of correlation intensity on a random forest model"}
library(mlr)
library(iml)
library(ggplot2)
library(randomForest)


res_desc <- makeResampleDesc("Subsample", iters = 5, split = 4/5)
data_sim5 ["y1sim5"] <- y1sim5
taskc = makeRegrTask(data = data_sim5  , target= "y1sim5")
learnerc = makeLearner("regr.randomForest")
featc = getTaskFeatureNames(taskc)
featc
mod.fullc = train(learnerc, taskc)
resc = resample(learner = learnerc, task = taskc, 
               resampling = res_desc,show.info = FALSE)

resultc <- data.frame(matrix(nrow=1,ncol=length(featc))) 

for(i in 1:length(featc)){
  taskfeatc = dropFeatures(taskc, featc[i])
  mod.featc = train(learnerc, dropFeatures(taskc, featc[i]))
  resfeatc = resample(learner = learnerc, task = taskfeatc, resampling = res_desc ,show.info = FALSE);
  importance_c = data.frame(resfeatc$aggr/resc$aggr)
  featurec = c(getTaskFeatureNames(taskc))
  resultc[i] <- importance_c
  #print(importance)
}
resultc
colnames(resultc) <- getTaskFeatureNames(taskc)
rownames(resultc) <- "importance_c"
FIPcsim5 <- data.frame(
  importancec= round((t(resultc)),3),
  featurec= getTaskFeatureNames(taskc))

locosim5 <- ggplot(data = FIPcsim5 ,aes(reorder(x=featurec,importance_c), y= importance_c)) + #### hier fehler 
  geom_point(size=3, shape=21, fill="green") +
  coord_flip() +
  theme(plot.subtitle = element_text(size = 10)) +
  labs(y = "Feature Importance", x= "") + 
  theme(text = element_text(size = 16))

locosim5
```

```{r LOCO08, message = FALSE,eval = FALSE , fig.height=6, fig.width=12, echo = FALSE, eval=FALSE, fig.cap="LOCO Feature Importance with different kind of correlation intensity on a random forest model"}
library(mlr)
library(iml)
library(ggplot2)
library(randomForest)


res_desc <- makeResampleDesc("Subsample", iters = 5, split = 4/5)
data_sim10 ["y1sim10"] <- y1sim10
taskc = makeRegrTask(data = data_sim10  , target= "y1sim10")
learnerc = makeLearner("regr.randomForest")
featc = getTaskFeatureNames(taskc)
featc
mod.fullc = train(learnerc, taskc)
resc = resample(learner = learnerc, task = taskc, 
               resampling = res_desc,show.info = FALSE)

resultc <- data.frame(matrix(nrow=1,ncol=length(featc))) 

for(i in 1:length(featc)){
  taskfeatc = dropFeatures(taskc, featc[i])
  mod.featc = train(learnerc, dropFeatures(taskc, featc[i]))
  resfeatc = resample(learner = learnerc, task = taskfeatc, resampling = res_desc ,show.info = FALSE);
  importance_c = data.frame(resfeatc$aggr/resc$aggr)
  featurec = c(getTaskFeatureNames(taskc))
  resultc[i] <- importance_c
  #print(importance)
}
resultc
colnames(resultc) <- getTaskFeatureNames(taskc)
rownames(resultc) <- "importance_c"
FIPcsim10 <- data.frame(
  importancec= round((t(resultc)),3),
  featurec= getTaskFeatureNames(taskc))

locosim10 <- ggplot(data = FIPcsim10 ,aes(reorder(x=featurec,importance_c), y= importance_c)) + 
  geom_point(size=3, shape=21, fill="red") +
  coord_flip() +
  theme(plot.subtitle = element_text(size = 10)) +
  labs(y = "Feature Importance", x= "") + 
  theme(text = element_text(size = 16))

locosim10
```

```{r arrange05, message = FALSE,eval = FALSE , fig.height=6, fig.width=12, fig.cap= "Comparison"}
library(ggpubr)
ggarrange(locosim5, locosim10 , ncol=2, legend = "bottom", common.legend = TRUE)
``` 



### Real Data

* Probably dataset "mtcars", because the features are highly correlated, but should be 
* Just showing the problem on a real data set to show the complex effects of correlated, real data
* But this chapter should be rather small

```{r PFIreal1, message = FALSE, eval = FALSE ,fig.height=6, fig.width=12, fig.cap= "Comparison"}
library(ggpubr)
library(corrplot)
library(randomForest)
library(mlr)

data("Boston", package = "MASS")
corrplot.mixed(cor(Boston),lower="circle",upper="number")
head(Boston)


rfboston <- randomForest(medv~. , data = Boston)


PFIb <- function(data,learner,target,model){
  d <- data
  task = makeRegrTask(data = data , target= target)
  learnerPFI = makeLearner(learner)
  res = resample(learner = learnerPFI, task = task, 
               resampling = res_desc,show.info = FALSE)
  resultPFI <- data.frame(matrix(nrow=13,ncol=1))
    for(i in 1:10){
    mod <- Predictor$new(model,
                          data=d[c(unlist(getResamplingIndices(res)$test.inds[i], use.names=FALSE)),1:13], 
                          y = d[c(unlist(getResamplingIndices(res)$test.inds[i], use.names=FALSE)),14])
    imp <- FeatureImp$new(mod, loss = "mse" , compare = "ratio")
    impo <- imp$results
    impo <- impo[order(impo$feature),]
    resultPFI[i] <- data.frame(impo$importance)
    }
imp.dat <- data.frame(rowSums(resultPFI)/10)
imp.dat["features"]<- impo$feature
colnames(imp.dat) <- c("importance","features")
return(imp.dat)
}

bostonimp <- PFIb(Boston,"regr.randomForest","medv", rfboston)

pb1 <- ggplot(data = bostonimp, aes(x=reorder(features, importance),y = importance)) +
    geom_point(size=0, stroke = 3, shape=21, fill="blue")+
    coord_flip() +
    theme(plot.subtitle = element_text(size = 10)) +
    labs(y = "Feature Importance MSE", x= "") + 
    theme(text = element_text(size = 14))+
    ggtitle("mtcars PFI on Random Forest")

pb1
``` 

```{r PFIreal2, message = FALSE,eval = FALSE , fig.height=6, fig.width=12, fig.cap= "Comparison"}
library(ggpubr)
library(corrplot)

Boston["dup_lstat"] <- Boston$lstat

rfBoston2 <- randomForest(medv~. , data = Boston)

PFIb2 <- function(data,learner,target,model){
  d <- data
  task = makeRegrTask(data = data , target= target)
  learnerPFI = makeLearner(learner)
  res = resample(learner = learnerPFI, task = task, 
               resampling = res_desc,show.info = FALSE)
  resultPFI <- data.frame(matrix(nrow=14,ncol=1))
    for(i in 1:10){
    mod <- Predictor$new(model,
                          data=d[c(unlist(getResamplingIndices(res)$test.inds[i], use.names=FALSE)),c(1:13,15)], 
                          y = d[c(unlist(getResamplingIndices(res)$test.inds[i], use.names=FALSE)),14])
    imp <- FeatureImp$new(mod, loss = "mse" , compare = "ratio")
    impo <- imp$results
    impo <- impo[order(impo$feature),]
    resultPFI[i] <- data.frame(impo$importance)
    }
imp.dat <- data.frame(rowSums(resultPFI)/10)
imp.dat["features"]<- impo$feature
colnames(imp.dat) <- c("importance","features")
return(imp.dat)
}

rfBostonimp <- PFIb2(Boston,"regr.randomForest","medv", rfBoston2)
head(Boston)

pb2 <- ggplot(data = rfBostonimp, aes(x= reorder(features, importance), y = importance)) +
    geom_point( size=0, stroke = 3, shape=21, fill="blue")+
    coord_flip() +
    theme(plot.subtitle = element_text(size = 10)) +
    labs(y = "Feature Importance MSE", x= "") + 
    theme(text = element_text(size = 14))+
    ggtitle("mtcars PFI on Random Forest")

pb2

``` 

```{r arrange06, message = FALSE,eval = FALSE , fig.height=6, fig.width=12, fig.cap= "Comparison"}
library(ggpubr)
ggarrange(pb1, pb2, ncol=2, legend = "bottom", common.legend = TRUE)
``` 




```{r LOCOreal1, message = FALSE, eval=FALSE, fig.height=6, fig.width=12, fig.cap= "Comparison"}

data("Boston", package = "MASS")

rfLOCOb <- LOCO(Boston, "regr.randomForest", "medv")


plocob1 <- ggplot(data = rfLOCOb ,aes(x=reorder(feature,importance),y = importance)) + #### hier fehler 
  geom_point(size=0, shape=21,stroke = 3, fill="black") +
  coord_flip() +
  theme(plot.subtitle = element_text(size = 10)) +
  labs(y = "Feature Importance MSE", x= "") + 
  theme(text = element_text(size = 14))+
  ggtitle("LOCO on Random Forest")

plocob1

``` 

```{r LOCOreal2, message = FALSE,eval = FALSE , fig.height=6, fig.width=12, fig.cap= "Comparison"}

data("Boston", package = "MASS")
Boston["dup_lstat"] <- Boston$lstat
rfLOCOb2 <- LOCO(Boston, "regr.randomForest", "medv")


plocob2 <- ggplot(data = rfLOCOb2 ,aes(x=reorder(feature,importance),y = importance)) + #### hier fehler 
  geom_point(size=0, shape=21,stroke = 3, fill="black") +
  coord_flip() +
  theme(plot.subtitle = element_text(size = 10)) +
  labs(y = "Feature Importance MSE", x= "") + 
  theme(text = element_text(size = 14))+
  ggtitle("LOCO on Random Forest")

plocob2

``` 

```{r arrange07, message = FALSE,eval = FALSE , fig.height=6, fig.width=12, fig.cap= "Comparison"}
library(ggpubr)
ggarrange(plocob1, plocob2, ncol=2, legend = "bottom", common.legend = TRUE)
``` 



## Unrealistic data instances







### Real Data

## Prevention of Correlation Problems

In summary, when features of a given data set are correlated, feature importance measures like LOCO or PFI can be strongly misleading. Thus, a check for correlated features before a usage of these two methods is recommended or in other words even necessary to have a credible interpretation. 

* Conditional variable importance (Strobl 2008)

